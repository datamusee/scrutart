<!-- templates/step_wordpress.html -->
{% extends "base.html" %}

{% block title %}Cr√©er un post WordPress{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title text-warning">üìù Cr√©ation de post WordPress</h2>

                <div class="alert alert-info">
                    Cette √©tape g√©n√®re automatiquement un billet de blog WordPress √† partir des donn√©es d'un artiste.
                </div>

                {% if prefill_structure %}
                <div class="alert alert-success">
                    ‚úÖ Le champ a √©t√© pr√©-rempli automatiquement avec les donn√©es de l'√©tape pr√©c√©dente
                </div>
                {% endif %}

                <form method="POST" action="{{ url_for('create_wordpress_post') }}" id="wordpressForm">
                    <div class="mb-3">
                        <label for="json_structure" class="form-label">
                            <strong>Structure JSON de l'artiste</strong>
                        </label>
                        <textarea
                            class="form-control font-monospace"
                            id="json_structure"
                            name="json_structure"
                            rows="8"
                            required
                            placeholder='{"categoryName": "...", "qid": "...", "piwigoCategory": "...", "listimagespath": "..."}'
                        >{{ prefill_structure if prefill_structure else '' }}</textarea>
                        <div class="form-text">
                            Collez ici la structure JSON compl√®te obtenue lors de la premi√®re √©tape (recherche d'artiste).
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeImages" name="include_images" checked>
                            <label class="form-check-label" for="includeImages">
                                Inclure les images dans le post
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoPublish" name="auto_publish">
                            <label class="form-check-label" for="autoPublish">
                                Publier automatiquement (sinon : brouillon)
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning btn-lg">
                            üìù G√©n√©rer le post WordPress
                        </button>
                        <a href="{{ url_for('menu') }}" class="btn btn-outline-secondary">
                            ‚Üê Retour au menu
                        </a>
                    </div>
                </form>

                <!-- Section d'aide -->
                <div class="mt-4">
                    <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#helpSection">
                        üí° Afficher l'aide
                    </button>
                    <div class="collapse mt-2" id="helpSection">
                        <div class="card card-body bg-light">
                            <h6>Format attendu :</h6>
                            <pre class="small"><code>{
  "categoryName": "Vincent van Gogh",
  "qid": "Q5582",
  "piwigoCategory": "123",
  "listimagespath": "D:/path/to/images.json"
}</code></pre>

                            <h6 class="mt-3">Le post WordPress g√©n√©r√© contiendra :</h6>
                            <ul class="small">
                                <li>Titre : "D√©couverte de l'artiste [Nom]"</li>
                                <li>Contenu HTML format√© avec informations Wikidata</li>
                                <li>Cat√©gories et tags automatiques</li>
                                <li>Images int√©gr√©es (si l'option est coch√©e)</li>
                                <li>M√©tadonn√©es SEO optimis√©es</li>
                            </ul>

                            <h6 class="mt-3">Configuration WordPress requise :</h6>
                            <p class="small mb-0">
                                Assurez-vous que votre configuration WordPress permet l'API REST et que les credentials sont correctement d√©finis dans vos variables d'environnement.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Aper√ßu de la structure -->
                <div class="mt-4">
                    <h5>Structure du post g√©n√©r√© :</h5>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="small mb-2"><strong>Sections :</strong></p>
                            <ol class="small mb-0">
                                <li>Introduction sur l'artiste</li>
                                <li>Informations biographiques (Wikidata)</li>
                                <li>Galerie d'≈ìuvres principales</li>
                                <li>Liens et ressources externes</li>
                                <li>Call-to-action pour visiter la galerie</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Validation JSON c√¥t√© client
document.getElementById('wordpressForm').addEventListener('submit', function(e) {
    const structureJson = document.getElementById('json_structure').value;

    try {
        const data = JSON.parse(structureJson);

        // V√©rifier les champs requis
        if (!data.categoryName || !data.qid) {
            throw new Error('Les champs "categoryName" et "qid" sont requis');
        }
    } catch (error) {
        e.preventDefault();
        alert('Erreur : Format JSON invalide ou champs manquants.\n\n' + error.message);
        return false;
    }
});
</script>
{% endblock %}