<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrichissement Wikidata - Peintures et Artistes</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Enrichissement Wikidata</h1>
            <nav>
                <a href="/" class="active">Accueil</a>
                <a href="/config">Configuration</a>
            </nav>
        </header>

        <main>
            <div class="input-section">
                <h2>Choisir la source</h2>
                
                <div class="tabs">
                    <button class="tab-button active" data-tab="single-url">URL Unique</button>
                    <button class="tab-button" data-tab="url-list">Liste d'URLs</button>
                </div>

                <!-- Onglet URL unique -->
                <div id="single-url" class="tab-content active">
                    <div class="input-group">
                        <label for="extractor-select-single">Extracteur :</label>
                        <select id="extractor-select-single" class="extractor-select">
                            <option value="">Auto (d√©tection automatique)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="url-input">URL √† traiter :</label>
                        <input type="url" id="url-input" placeholder="https://exemple.com/peinture" />
                        <button id="process-url-btn" class="btn-primary">Traiter</button>
                    </div>
                </div>

                <!-- Onglet Liste d'URLs -->
                <div id="url-list" class="tab-content">
                    <div class="input-group">
                        <label for="extractor-select-list">Extracteur pour la liste :</label>
                        <select id="extractor-select-list" class="extractor-select">
                            <option value="">Auto (d√©tection automatique)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="file-input">Charger un fichier de liste :</label>
                        <input type="file" id="file-input" accept=".txt,.csv" />
                        <button id="upload-list-btn" class="btn-primary">Charger</button>
                    </div>
                    
                    <div id="list-info" class="list-info" style="display: none;">
                        <p>Fichier : <span id="list-filename"></span></p>
                        <p>URLs : <span id="list-count"></span></p>
                        <p>Extracteur : <span id="list-extractor"></span></p>
                        <p>Progression : <span id="list-progress"></span></p>
                        
                        <div class="list-controls">
                            <button id="reset-list-btn" class="btn-secondary">R√©initialiser</button>
                            <button id="resume-list-btn" class="btn-secondary">Reprendre</button>
                            <button id="restart-list-btn" class="btn-secondary">Tout retraiter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section de r√©sultats -->
            <div id="results-section" style="display: none;">
                <h2>R√©sultats de l'extraction</h2>
                
                <div class="navigation-controls" id="nav-controls" style="display: none;">
                    <button id="prev-btn" class="btn-secondary">‚Üê Pr√©c√©dent</button>
                    <span id="current-position"></span>
                    <button id="next-btn" class="btn-secondary">Suivant ‚Üí</button>
                </div>

                <div id="content-info" class="content-card">
                    <h3>Informations extraites</h3>
                    <div class="extractor-badge" id="extractor-used"></div>
                    <div id="content-details"></div>
                    
                    <!-- Bouton pour matcher les propri√©t√©s -->
                    <div class="property-matching-actions">
                        <button id="match-properties-btn" class="btn-match">
                            üîç Matcher les propri√©t√©s avec Wikidata
                        </button>
                    </div>
                </div>

                <!-- Correspondances Wikidata -->
                <div id="wikidata-matches" class="matches-section">
                    <h3>Entit√©s Wikidata correspondantes</h3>
                    <div id="matches-list"></div>
                    <button id="create-new-btn" class="btn-create">Cr√©er une nouvelle entit√©</button>
                </div>

                <!-- Section de Property Matching -->
                <div id="property-matching-section" class="matches-section" style="display: none;">
                    <h3>üîó Associations Propri√©t√©s ‚Üí Wikidata</h3>
                    <p class="info-text">
                        Validez les associations propos√©es entre les propri√©t√©s extraites et les entit√©s Wikidata.
                    </p>
                    <div id="property-matches-list"></div>
                    <div class="property-matching-summary">
                        <button id="validate-all-properties-btn" class="btn-primary" style="display: none;">
                            Valider toutes les associations
                        </button>
                    </div>
                </div>

                <!-- Sections existantes -->
                <div id="creator-section" class="matches-section" style="display: none;">
                    <h3>Cr√©ateur</h3>
                    <div id="creator-info"></div>
                </div>

                <div id="persons-section" class="matches-section" style="display: none;">
                    <h3>Personnes repr√©sent√©es</h3>
                    <div id="persons-list"></div>
                </div>

                <div id="concepts-section" class="matches-section" style="display: none;">
                    <h3>Concepts et Mots-cl√©s</h3>
                    <div id="concepts-list"></div>
                </div>

                <!-- Section de validation -->
                <div id="validation-section" style="display: none;">
                    <h3>Validation des propri√©t√©s</h3>
                    <div id="properties-list"></div>
                    <div class="validation-actions">
                        <button id="confirm-btn" class="btn-primary">Confirmer</button>
                        <button id="cancel-btn" class="btn-secondary">Annuler</button>
                    </div>
                </div>
            </div>

            <!-- Section de cr√©ation d'entit√© -->
            <div id="creation-section" style="display: none;">
                <h2>Cr√©ation d'une nouvelle entit√©</h2>
                <div id="creation-properties"></div>
                <div class="creation-actions">
                    <button id="create-confirm-btn" class="btn-primary">Cr√©er l'entit√©</button>
                    <button id="create-cancel-btn" class="btn-secondary">Annuler</button>
                </div>
            </div>

            <!-- Messages -->
            <div id="message-area" class="message-area"></div>
        </main>
    </div>

    <script>
        // √âtat de l'application
        let appState = {
            mode: 'single',
            currentListFile: null,
            currentIndex: 0,
            totalUrls: 0,
            extractors: [],
            currentContentInfo: null,
            currentEntityType: null,
            propertyMatches: null,
            validatedProperties: {}
        };

        // [... le reste du JavaScript existant ...]
        // Pour la concision, je vais ajouter seulement les nouvelles fonctions

        // Bouton pour matcher les propri√©t√©s
        document.getElementById('match-properties-btn').addEventListener('click', async () => {
            if (!appState.currentContentInfo) {
                showMessage('Aucune donn√©e √† matcher', 'error');
                return;
            }
            
            showMessage('Recherche des correspondances...', 'info');
            
            try {
                const response = await fetch('/match_properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        extracted_data: appState.currentContentInfo,
                        entity_type: appState.currentEntityType || 'painting'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erreur lors du matching des propri√©t√©s');
                }
                
                const data = await response.json();
                appState.propertyMatches = data.property_matches;
                
                displayPropertyMatches(data.property_matches);
                showMessage('Correspondances trouv√©es !', 'success');
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'error');
            }
        });

        // Afficher les property matches
        function displayPropertyMatches(propertyMatches) {
            const section = document.getElementById('property-matching-section');
            const listDiv = document.getElementById('property-matches-list');
            
            if (!propertyMatches || Object.keys(propertyMatches).length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            let html = '';
            
            // Cr√©ateur
            if (propertyMatches.creator && propertyMatches.creator.length > 0) {
                html += generatePropertyMatchSection('Cr√©ateur', 'creator', propertyMatches.creator);
            }
            
            // Personnes repr√©sent√©es
            if (propertyMatches.depicted_persons) {
                for (const [person, matches] of Object.entries(propertyMatches.depicted_persons)) {
                    html += generatePropertyMatchSection(
                        `Personne: ${person}`, 
                        `depicted_person_${person}`, 
                        matches
                    );
                }
            }
            
            // Mots-cl√©s
            if (propertyMatches.keywords) {
                for (const [keyword, matches] of Object.entries(propertyMatches.keywords)) {
                    html += generatePropertyMatchSection(
                        `Concept: ${keyword}`, 
                        `keyword_${keyword}`, 
                        matches
                    );
                }
            }
            
            // Mat√©riau
            if (propertyMatches.material && propertyMatches.material.length > 0) {
                html += generatePropertyMatchSection('Mat√©riau', 'material', propertyMatches.material);
            }
            
            // Collection
            if (propertyMatches.collection && propertyMatches.collection.length > 0) {
                html += generatePropertyMatchSection('Collection', 'collection', propertyMatches.collection);
            }
            
            // Mouvement
            if (propertyMatches.movement && propertyMatches.movement.length > 0) {
                html += generatePropertyMatchSection('Mouvement', 'movement', propertyMatches.movement);
            }
            
            listDiv.innerHTML = html;
            
            // Afficher le bouton de validation globale
            if (html) {
                document.getElementById('validate-all-properties-btn').style.display = 'block';
            }
        }

        // G√©n√©rer une section de property match
        function generatePropertyMatchSection(title, propertyKey, matches) {
            let html = `
                <div class="property-match-group">
                    <h4>${title}</h4>
                    <div class="property-match-options">
            `;
            
            matches.forEach((match, index) => {
                const matchId = `${propertyKey}_${index}`;
                html += `
                    <div class="property-match-option" data-property="${propertyKey}" data-match-id="${matchId}">
                        <div class="match-header">
                            <input type="radio" 
                                   name="prop_${propertyKey}" 
                                   id="${matchId}" 
                                   value="${match.id}"
                                   data-property="${match.property}"
                                   data-property-label="${match.property_label}">
                            <label for="${matchId}">
                                <strong>${match.label}</strong> (${match.id})
                                <span class="confidence-badge confidence-${getConfidenceClass(match.confidence)}">
                                    ${(match.confidence * 100).toFixed(0)}%
                                </span>
                            </label>
                        </div>
                        ${match.description ? `<p class="match-desc">${match.description}</p>` : ''}
                        ${match.birth || match.death ? `
                            <p class="match-dates">
                                ${match.birth ? `Naissance: ${match.birth}` : ''}
                                ${match.death ? ` | Mort: ${match.death}` : ''}
                            </p>
                        ` : ''}
                        <a href="${match.url}" target="_blank" class="match-link">Voir dans Wikidata ‚Üí</a>
                    </div>
                `;
            });
            
            html += `
                        <div class="property-match-option">
                            <input type="radio" 
                                   name="prop_${propertyKey}" 
                                   id="${propertyKey}_none" 
                                   value="none">
                            <label for="${propertyKey}_none">
                                <em>Aucune correspondance / Ne pas ajouter</em>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        // Classe de confiance
        function getConfidenceClass(confidence) {
            if (confidence >= 0.9) return 'high';
            if (confidence >= 0.7) return 'medium';
            return 'low';
        }

        // Valider toutes les propri√©t√©s s√©lectionn√©es
        document.getElementById('validate-all-properties-btn').addEventListener('click', () => {
            const selectedProperties = [];
            
            // Parcourir tous les radio buttons s√©lectionn√©s
            document.querySelectorAll('.property-match-option input[type="radio"]:checked').forEach(radio => {
                if (radio.value !== 'none') {
                    selectedProperties.push({
                        property: radio.dataset.property,
                        property_label: radio.dataset.propertyLabel,
                        entity_id: radio.value
                    });
                }
            });
            
            if (selectedProperties.length === 0) {
                showMessage('Aucune propri√©t√© s√©lectionn√©e', 'warning');
                return;
            }
            
            appState.validatedProperties = selectedProperties;
            
            showMessage(`${selectedProperties.length} propri√©t√©(s) valid√©e(s) et pr√™te(s) √† √™tre ajout√©e(s)`, 'success');
            
            // Afficher le r√©capitulatif
            displayPropertySummary(selectedProperties);
        });

        // Afficher le r√©capitulatif des propri√©t√©s valid√©es
        function displayPropertySummary(properties) {
            const summaryDiv = document.querySelector('.property-matching-summary');
            
            let html = `
                <div class="property-summary">
                    <h4>Propri√©t√©s √† ajouter :</h4>
                    <ul>
            `;
            
            properties.forEach(prop => {
                html += `<li><strong>${prop.property_label}</strong>: ${prop.entity_id}</li>`;
            });
            
            html += `
                    </ul>
                    <p class="info-text">
                        Ces propri√©t√©s seront ajout√©es lorsque vous confirmerez l'enrichissement de l'entit√©.
                    </p>
                </div>
            `;
            
            summaryDiv.innerHTML += html;
        }

        // Afficher un message
        function showMessage(message, type) {
            const div = document.createElement('div');
            div.className = 'message message-' + type;
            div.textContent = message;
            document.getElementById('message-area').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        // Charger les extracteurs au d√©marrage
        async function loadExtractors() {
            try {
                const response = await fetch('/list_extractors');
                const data = await response.json();
                appState.extractors = data.extractors;
                
                // Remplir les selects
                const selects = document.querySelectorAll('.extractor-select');
                selects.forEach(select => {
                    data.extractors.forEach(ext => {
                        const option = document.createElement('option');
                        option.value = ext.name;
                        option.textContent = `${ext.name} - ${ext.description}`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Erreur chargement extracteurs:', error);
            }
        }

        // Charger au d√©marrage
        loadExtractors();

        // [... Le reste du code JavaScript existant ...]
    </script>
</body>
</html>
