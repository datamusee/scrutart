<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrutart - Automation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e8ed;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .logs-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .qid-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qid-info {
            flex: 1;
        }

        .qid-actions {
            display: flex;
            gap: 10px;
        }

        .icon {
            font-size: 1.2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Scrutart Automation</h1>
            <p>Interface de gestion automatis√©e des contenus artistiques</p>
        </div>

        <div class="main-content">
            <div class="grid">
                <!-- Traitement individuel -->
                <div class="card">
                    <h2><span class="icon">üë§</span> Traitement individuel</h2>
                    <div class="form-group">
                        <label for="single-qid">QID Wikidata de l'artiste</label>
                        <input type="text" id="single-qid" class="form-control" placeholder="Q296" />
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Exemple: Q296 pour Claude Monet
                        </small>
                    </div>
                    <button class="btn" onclick="processSingleArtist()">
                        <span class="icon">üöÄ</span> Lancer le traitement
                    </button>
                    <button class="btn btn-secondary" onclick="previewArtist()">
                        <span class="icon">üëÅÔ∏è</span> Aper√ßu
                    </button>
                </div>

                <!-- Traitement par lots -->
                <div class="card">
                    <h2><span class="icon">üìã</span> Traitement par lots</h2>
                    <div class="form-group">
                        <label for="batch-qids">Liste des QID (un par ligne)</label>
                        <textarea id="batch-qids" class="form-control textarea" placeholder="Q296&#10;Q5582&#10;Q5597&#10;Q762&#10;Q46373"></textarea>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Entrez un QID par ligne. Exemple: Q296, Q5582, Q5597...
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="batch-name">Nom du lot (optionnel)</label>
                        <input type="text" id="batch-name" class="form-control" placeholder="Impressionnistes fran√ßais" />
                    </div>
                    <button class="btn" onclick="processBatch()">
                        <span class="icon">‚ö°</span> Traitement par lot
                    </button>
                    <button class="btn btn-secondary" onclick="validateBatch()">
                        <span class="icon">‚úÖ</span> Valider la liste
                    </button>
                    <button class="btn btn-secondary" onclick="loadBatchTemplate()">
                        <span class="icon">üìÑ</span> Charger mod√®le
                    </button>
                </div>
            </div>

            <!-- Panneau de statut -->
            <div class="card">
                <h2><span class="icon">üìä</span> Statut des traitements</h2>
                <div class="status-panel" id="status-panel">
                    <div class="status-item">
                        <span>Aucun traitement en cours</span>
                        <span class="status-badge status-pending">En attente</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="refreshStatus()">
                        <span class="icon">üîÑ</span> Actualiser
                    </button>
                    <button class="btn btn-danger" onclick="cancelAll()">
                        <span class="icon">‚èπÔ∏è</span> Annuler tout
                    </button>
                </div>
            </div>

            <!-- Liste des traitements r√©cents -->
            <div class="card">
                <h2><span class="icon">üìú</span> Historique des traitements</h2>
                <div id="processing-history">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
                <button class="btn btn-secondary" onclick="clearHistory()">
                    <span class="icon">üóëÔ∏è</span> Vider l'historique
                </button>
                <button class="btn btn-secondary" onclick="exportHistory()">
                    <span class="icon">üíæ</span> Exporter
                </button>
            </div>

            <!-- Configuration -->
            <div class="card">
                <h2><span class="icon">‚öôÔ∏è</span> Configuration</h2>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label for="prefect-url">URL Prefect Server</label>
                            <input type="text" id="prefect-url" class="form-control" value="http://localhost:4200" />
                        </div>
                        <div class="form-group">
                            <label for="batch-size">Taille des lots</label>
                            <input type="number" id="batch-size" class="form-control" value="10" min="1" max="50" />
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="languages">Langues de g√©n√©ration</label>
                            <select id="languages" class="form-control" multiple>
                                <option value="fr" selected>Fran√ßais</option>
                                <option value="en">Anglais</option>
                                <option value="es">Espagnol</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="auto-publish">Publication automatique</label>
                            <select id="auto-publish" class="form-control">
                                <option value="draft">Brouillon</option>
                                <option value="publish">Publier directement</option>
                                <option value="review">En r√©vision</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveConfig()">
                    <span class="icon">üíæ</span> Sauvegarder la configuration
                </button>
            </div>

            <!-- Logs -->
            <div class="card">
                <h2><span class="icon">üìù</span> Logs temps r√©el</h2>
                <div class="logs-container" id="logs-container">
                    Logs d'ex√©cution...
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="clearLogs()">
                        <span class="icon">üßπ</span> Vider les logs
                    </button>
                    <button class="btn btn-secondary" onclick="downloadLogs()">
                        <span class="icon">üì•</span> T√©l√©charger
                    </button>
                    <label style="margin-left: 20px;">
                        <input type="checkbox" id="auto-scroll" checked> Auto-scroll
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates de lots pr√©d√©finis -->
    <div id="batch-templates" style="display: none;">
        <div data-name="Impressionnistes fran√ßais" data-qids="Q296,Q5582,Q5597,Q762,Q46373"></div>
        <div data-name="Peintres de la Renaissance" data-qids="Q762,Q5590,Q5598,Q1267,Q5577"></div>
        <div data-name="Art moderne" data-qids="Q5593,Q37693,Q5582,Q5597,Q153739"></div>
    </div>

    <script>
        // Configuration globale
        let config = {
            prefectUrl: 'http://localhost:4200',
            batchSize: 10,
            languages: ['fr'],
            autoPublish: 'draft'
        };

        let currentProcessing = [];
        let processingHistory = [];
        let wsConnection = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            initWebSocket();
            loadHistory();
            updateStatusPanel();
        });

        // Fonctions principales
        async function processSingleArtist() {
            const qid = document.getElementById('single-qid').value.trim();
            
            if (!qid) {
                showNotification('Veuillez entrer un QID valide', 'error');
                return;
            }

            if (!isValidQID(qid)) {
                showNotification('Format QID invalide (exemple: Q296)', 'error');
                return;
            }

            try {
                showNotification('Lancement du traitement...', 'info');
                
                const response = await fetch(`${config.prefectUrl}/api/flows/process-artist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qid: qid,
                        languages: config.languages,
                        auto_publish: config.autoPublish
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    addToProcessing(qid, 'single', result.flow_run_id);
                    showNotification('Traitement lanc√© avec succ√®s', 'success');
                    document.getElementById('single-qid').value = '';
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            } catch (error) {
                showNotification(`Erreur: ${error.message}`, 'error');
                logMessage(`Erreur traitement ${qid}: ${error.message}`, 'error');
            }
        }

        async function processBatch() {
            const qidsText = document.getElementById('batch-qids').value.trim();
            const batchName = document.getElementById('batch-name').value.trim() || `Lot ${new Date().toLocaleString()}`;
            
            if (!qidsText) {
                showNotification('Veuillez entrer au moins un QID', 'error');
                return;
            }

            const qids = qidsText.split('\n')
                .map(qid => qid.trim())
                .filter(qid => qid && isValidQID(qid));

            if (qids.length === 0) {
                showNotification('Aucun QID valide trouv√©', 'error');
                return;
            }

            try {
                showNotification(`Lancement du traitement pour ${qids.length} artistes...`, 'info');
                
                const response = await fetch(`${config.prefectUrl}/api/flows/process-batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qids: qids,
                        batch_name: batchName,
                        batch_size: config.batchSize,
                        languages: config.languages,
                        auto_publish: config.autoPublish
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    addToProcessing(batchName, 'batch', result.flow_run_id, qids);
                    showNotification('Traitement par lot lanc√© avec succ√®s', 'success');
                    document.getElementById('batch-qids').value = '';
                    document.getElementById('batch-name').value = '';
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            } catch (error) {
                showNotification(`Erreur: ${error.message}`, 'error');
                logMessage(`Erreur traitement lot: ${error.message}`, 'error');
            }
        }

        async function previewArtist() {
            const qid = document.getElementById('single-qid').value.trim();
            
            if (!qid || !isValidQID(qid)) {
                showNotification('QID invalide', 'error');
                return;
            }

            try {
                const response = await fetch(`https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&format=json&origin=*`);
                const data = await response.json();
                
                if (data.entities && data.entities[qid]) {
                    const entity = data.entities[qid];
                    const label = entity.labels?.fr?.value || entity.labels?.en?.value || 'Nom non disponible';
                    const description = entity.descriptions?.fr?.value || entity.descriptions?.en?.value || 'Description non disponible';
                    
                    showNotification(`Aper√ßu: ${label} - ${description}`, 'info');
                    logMessage(`Aper√ßu ${qid}: ${label}`, 'info');
                } else {
                    showNotification('Artiste non trouv√© sur Wikidata', 'error');
                }
            } catch (error) {
                showNotification(`Erreur lors de l'aper√ßu: ${error.message}`, 'error');
            }
        }

        function validateBatch() {
            const qidsText = document.getElementById('batch-qids').value.trim();
            
            if (!qidsText) {
                showNotification('Veuillez entrer des QID', 'error');
                return;
            }

            const lines = qidsText.split('\n');
            let validCount = 0;
            let invalidLines = [];

            lines.forEach((line, index) => {
                const qid = line.trim();
                if (qid) {
                    if (isValidQID(qid)) {
                        validCount++;
                    } else {
                        invalidLines.push(index + 1);
                    }
                }
            });

            if (invalidLines.length > 0) {
                showNotification(`${validCount} QID valides, ${invalidLines.length} invalides (lignes: ${invalidLines.join(', ')})`, 'error');
            } else {
                showNotification(`${validCount} QID valides`, 'success');
            }

            logMessage(`Validation lot: ${validCount} valides, ${invalidLines.length} invalides`);
        }

        function loadBatchTemplate() {
            const templates = document.getElementById('batch-templates').children;
            let templateOptions = '';
            
            for (let template of templates) {
                templateOptions += `<option value="${template.dataset.qids}">${template.dataset.name}</option>`;
            }

            const select = document.createElement('select');
            select.innerHTML = `<option value="">Choisir un mod√®le...</option>${templateOptions}`;
            select.className = 'form-control';
            select.style.marginBottom = '10px';

            select.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('batch-qids').value = this.value.split(',').join('\n');
                    this.remove();
                }
            });

            const batchCard = document.getElementById('batch-qids').parentNode.parentNode;
            batchCard.insertBefore(select, batchCard.querySelector('button'));
        }

        // Fonctions utilitaires
        function isValidQID(qid) {
            return /^Q\d+$/.test(qid);
        }

        function addToProcessing(name, type, flowRunId, qids = null) {
            const processing = {
                id: flowRunId,
                name: name,
                type: type,
                qids: qids,
                status: 'processing',
                startTime: new Date(),
                progress: 0
            };

            currentProcessing.push(processing);
            updateStatusPanel();
        }

        function updateStatusPanel() {
            const panel = document.getElementById('status-panel');
            
            if (currentProcessing.length === 0) {
                panel.innerHTML = `
                    <div class="status-item">
                        <span>Aucun traitement en cours</span>
                        <span class="status-badge status-pending">En attente</span>
                    </div>
                `;
                document.getElementById('progress-fill').style.width = '0%';
            } else {
                let html = '';
                let totalProgress = 0;
                
                currentProcessing.forEach(item => {
                    const duration = Math.floor((new Date() - item.startTime) / 1000);
                    const statusClass = `status-${item.status}`;
                    
                    html += `
                        <div class="status-item">
                            <div>
                                <strong>${item.name}</strong>
                                <small style="display: block; color: #666;">
                                    ${item.type === 'batch' ? `${item.qids?.length || 0} artistes` : 'Artiste unique'} - 
                                    Dur√©e: ${duration}s
                                </small>
                            </div>
                            <span class="status-badge ${statusClass}">${item.status}</span>
                        </div>
                    `;
                    
                    totalProgress += item.progress;
                });
                
                panel.innerHTML = html;
                
                const avgProgress = currentProcessing.length > 0 ? totalProgress / currentProcessing.length : 0;
                document.getElementById('progress-fill').style.width = `${avgProgress}%`;
            }
        }

        async function refreshStatus() {
            showNotification('Actualisation du statut...', 'info');
            
            for (let item of currentProcessing) {
                try {
                    const response = await fetch(`${config.prefectUrl}/api/flow_runs/${item.id}`);
                    if (response.ok) {
                        const data = await response.json();
                        item.status = data.state?.type?.toLowerCase() || 'unknown';
                        
                        if (data.state?.type === 'COMPLETED') {
                            item.progress = 100;
                            // D√©placer vers l'historique apr√®s un d√©lai
                            setTimeout(() => moveToHistory(item), 5000);
                        } else if (data.state?.type === 'FAILED') {
                            item.status = 'error';
                            setTimeout(() => moveToHistory(item), 10000);
                        }
                    }
                } catch (error) {
                    console.error('Erreur actualisation statut:', error);
                }
            }
            
            updateStatusPanel();
        }

        function moveToHistory(item) {
            const index = currentProcessing.findIndex(p => p.id === item.id);
            if (index > -1) {
                item.endTime = new Date();
                processingHistory.unshift(currentProcessing.splice(index, 1)[0]);
                updateStatusPanel();
                updateHistoryPanel();
                saveHistory();
            }
        }

        function updateHistoryPanel() {
            const historyPanel = document.getElementById('processing-history');
            
            if (processingHistory.length === 0) {
                historyPanel.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Aucun historique disponible</p>';
                return;
            }

            let html = '';
            processingHistory.slice(0, 10).forEach(item => {
                const duration = item.endTime ? Math.floor((item.endTime - item.startTime) / 1000) : 0;
                const statusClass = `status-${item.status}`;
                
                html += `
                    <div class="qid-item">
                        <div class="qid-info">
                            <strong>${item.name}</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${item.type === 'batch' ? `${item.qids?.length || 0} artistes` : 'Artiste unique'} - 
                                Dur√©e: ${duration}s - 
                                ${item.startTime.toLocaleString()}
                            </div>
                        </div>
                        <div class="qid-actions">
                            <span class="status-badge ${statusClass}">${item.status}</span>
                        </div>
                    </div>
                `;
            });
            
            historyPanel.innerHTML = html;
        }

        async function cancelAll() {
            if (currentProcessing.length === 0) {
                showNotification('Aucun traitement √† annuler', 'info');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir annuler tous les traitements en cours ?')) {
                return;
            }

            try {
                for (let item of currentProcessing) {
                    await fetch(`${config.prefectUrl}/api/flow_runs/${item.id}/set_state`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ state: { type: 'CANCELLED' } })
                    });
                }
                
                currentProcessing.forEach(item => {
                    item.status = 'cancelled';
                    moveToHistory(item);
                });
                
                showNotification('Tous les traitements ont √©t√© annul√©s', 'success');
            } catch (error) {
                showNotification(`Erreur lors de l'annulation: ${error.message}`, 'error');
            }
        }

        // Gestion des logs
        function logMessage(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logs-container');
            
            const levelEmoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            
            const logLine = `[${timestamp}] ${levelEmoji[level] || '‚ÑπÔ∏è'} ${message}\n`;
            logContainer.textContent += logLine;
            
            if (document.getElementById('auto-scroll').checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function clearLogs() {
            document.getElementById('logs-container').textContent = 'Logs vid√©s...\n';
        }

        function downloadLogs() {
            const logs = document.getElementById('logs-container').textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `scrutart-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Gestion des notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Gestion de la configuration
        function saveConfig() {
            config.prefectUrl = document.getElementById('prefect-url').value;
            config.batchSize = parseInt(document.getElementById('batch-size').value);
            config.autoPublish = document.getElementById('auto-publish').value;
            
            const languageSelect = document.getElementById('languages');
            config.languages = Array.from(languageSelect.selectedOptions).map(opt => opt.value);
            
            localStorage.setItem('scrutart-config', JSON.stringify(config));
            showNotification('Configuration sauvegard√©e', 'success');
        }

        function loadConfig() {
            const savedConfig = localStorage.getItem('scrutart-config');
            if (savedConfig) {
                config = { ...config, ...JSON.parse(savedConfig) };
                
                document.getElementById('prefect-url').value = config.prefectUrl;
                document.getElementById('batch-size').value = config.batchSize;
                document.getElementById('auto-publish').value = config.autoPublish;
                
                const languageSelect = document.getElementById('languages');
                Array.from(languageSelect.options).forEach(opt => {
                    opt.selected = config.languages.includes(opt.value);
                });
            }
        }

        function clearHistory() {
            if (confirm('√ätes-vous s√ªr de vouloir vider l\'historique ?')) {
                processingHistory = [];
                updateHistoryPanel();
                localStorage.removeItem('scrutart-history');
                showNotification('Historique vid√©', 'success');
            }
        }

        function exportHistory() {
            const data = JSON.stringify(processingHistory, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `scrutart-history-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function saveHistory() {
            localStorage.setItem('scrutart-history', JSON.stringify(processingHistory.slice(0, 50)));
        }

        function loadHistory() {
            const savedHistory = localStorage.getItem('scrutart-history');
            if (savedHistory) {
                processingHistory = JSON.parse(savedHistory);
                updateHistoryPanel();
            }
        }

        // WebSocket pour les mises √† jour en temps r√©el
        function initWebSocket() {
            try {
                wsConnection = new WebSocket('ws://localhost:4200/ws');
                
                wsConnection.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'flow_run_update') {
                        updateFlowRunStatus(data.flow_run_id, data.state);
                    } else if (data.type === 'log') {
                        logMessage(data.message, data.level);
                    }
                };
                
                wsConnection.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                wsConnection.onclose = function() {
                    // Tentative de reconnexion apr√®s 5 secondes
                    setTimeout(initWebSocket, 5000);
                };
            } catch (error) {
                console.warn('WebSocket non disponible:', error);
            }
        }

        function updateFlowRunStatus(flowRunId, state) {
            const item = currentProcessing.find(p => p.id === flowRunId);
            if (item) {
                item.status = state.type.toLowerCase();
                updateStatusPanel();
            }
        }

        // Raccourcis clavier
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (document.activeElement === document.getElementById('single-qid')) {
                            processSingleArtist();
                        } else if (document.activeElement === document.getElementById('batch-qids')) {
                            processBatch();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshStatus();
                        break;
                }
            }
        });

        // Auto-actualisation du statut toutes les 30 secondes
        setInterval(refreshStatus, 30000);

        // Message de bienvenue
        setTimeout(() => {
            logMessage('Interface Scrutart initialis√©e', 'success');
            showNotification('Interface pr√™te √† l\'utilisation', 'success');
        }, 1000);
    </script>
</body>
</html>